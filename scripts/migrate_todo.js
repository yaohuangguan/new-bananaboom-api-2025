// migrate_sessions.js
import { connect } from 'mongoose';
import { find, updateMany } from '../models/Chat';
import Conversation from '../models/Conversation';
import { find as _find } from '../models/User'; // å‡è®¾ä½ æœ‰ User æ¨¡å‹

const MONGO_URI = process.env.MONGO_URI || 'mongodb://localhost:27017/ä½ çš„æ•°æ®åº“å';

// ç”Ÿæˆ UUID çš„ç®€å•å‡½æ•°
const uuidv4 = () => {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
    var r = (Math.random() * 16) | 0,
      v = c == 'x' ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
};

const migrate = async () => {
  try {
    await connect(MONGO_URI);
    console.log('ğŸ”¥ æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œå¼€å§‹è¿ç§»...');

    // 1. æ‰¾å‡ºæ‰€æœ‰â€œæœ‰èŠå¤©è®°å½•â€ä½†â€œæ²¡åœ¨ Conversation è¡¨é‡Œæ³¨å†Œè¿‡â€çš„ç”¨æˆ·
    // è¿™é‡Œæˆ‘ä»¬ç®€å•ç‚¹ï¼šéå†æ‰€æœ‰ç”¨æˆ·ï¼Œç»™æ¯ä¸ªç”¨æˆ·å¤„ç†æ—§æ•°æ®
    const users = await _find({});

    for (const user of users) {
      const userId = user._id;
      const aiRoomName = `ai_session_${userId}`;

      // 2. æŸ¥æ‰¾è¯¥ç”¨æˆ·æ‰€æœ‰å±äº AI æˆ¿é—´ä¸”æ²¡æœ‰ sessionId çš„æ¶ˆæ¯
      const legacyMessages = await find({
        room: aiRoomName,
        sessionId: { $exists: false } // æˆ–è€… $eq: null
      });

      if (legacyMessages.length === 0) {
        console.log(`ç”¨æˆ· ${user.displayName} (ID: ${userId}) æ²¡æœ‰æ—§æ•°æ®ï¼Œè·³è¿‡ã€‚`);
        continue;
      }

      console.log(`ğŸ”„ å‘ç°ç”¨æˆ· ${user.displayName} æœ‰ ${legacyMessages.length} æ¡æ—§æ¶ˆæ¯ï¼Œæ­£åœ¨å½’æ¡£...`);

      // 3. åˆ›å»ºä¸€ä¸ªâ€œå†å²å½’æ¡£â€ä¼šè¯
      const archiveSessionId = uuidv4();

      const archiveConversation = new Conversation({
        user: userId,
        sessionId: archiveSessionId,
        title: 'ğŸ˜„åˆæ¬¡å¯¹è¯èŠå¤©è®°å½•', // ç»™ä¸ªæ˜¾çœ¼çš„åå­—
        isTitleAutoGenerated: true, // æ ‡è®°ä¸ºå·²ç”Ÿæˆï¼Œé˜²æ­¢ AI ä»¥åæ”¹å
        lastActiveAt: new Date() // è®¾ä¸ºç°åœ¨ï¼Œè®©å®ƒæ’åœ¨æœ€å‰
      });

      await archiveConversation.save();

      // 4. æ‰¹é‡æ›´æ–° Chat è®°å½•
      const result = await updateMany(
        {
          room: aiRoomName,
          sessionId: { $exists: false }
        },
        {
          $set: { sessionId: archiveSessionId }
        }
      );

      console.log(`âœ… ç”¨æˆ· ${user.displayName} å½’æ¡£å®Œæˆï¼æ›´æ–°äº† ${result.modifiedCount} æ¡æ¶ˆæ¯ã€‚`);
    }

    console.log('ğŸ‰ æ‰€æœ‰è¿ç§»å·¥ä½œå®Œæˆï¼');
    process.exit(0);
  } catch (err) {
    console.error('âŒ è¿ç§»å¤±è´¥:', err);
    process.exit(1);
  }
};

migrate();
